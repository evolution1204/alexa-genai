# 会話継続機能 - 更新ガイド

## 📝 更新内容の概要

日本語の自然な会話継続を実現するため、以下の改善を実施しました：

### 1. インタラクションモデルの強化
- 200以上の会話継続パターンを追加
- 短い返答への対応
- 数字での選択への対応
- 相槌・確認表現への対応

### 2. Lambda関数の改善
- 会話履歴100件まで保持
- 短い返答を文脈で理解
- セッション維持機能

## 🚀 Alexa開発者コンソールへの反映手順

### Step 1: インタラクションモデルの更新

1. [Alexa開発者コンソール](https://developer.amazon.com/alexa/console/ask)にログイン
2. 「GenAIアシスタント」スキルを選択
3. **「ビルド」タブ**をクリック（重要：コードタブではない）
4. 左メニューから **「JSONエディター」**を選択
5. `ja-JP.json`の内容を全選択してコピー＆ペースト
6. **「モデルを保存」**ボタンをクリック
7. **「モデルをビルド」**ボタンをクリック
8. ビルド完了まで待つ（1-2分）

### Step 2: Lambda関数の更新

1. **「コード」タブ**に移動
2. `lambda_function.py`を開く
3. ローカルの最新版をコピー＆ペースト
4. **「保存」**ボタンをクリック
5. **「デプロイ」**ボタンをクリック

### Step 3: 動作確認

1. **「テスト」タブ**に移動
2. スキルテストを「開発」に設定
3. 以下のテストシナリオを実行

## ✅ テストシナリオ

### 基本的な会話継続
```
You: じぇないを開いて
Alexa: じぇないアシスタントへようこそ

You: 東京について調べて
Alexa: 東京についてですね。どのような情報が...

You: 天気でお願いします
Alexa: 東京の天気について...（文脈を理解）
```

### 番号での選択
```
You: 1番
Alexa: （最初の選択肢について回答）

You: 次の
Alexa: （次の項目について回答）
```

### 相槌・継続
```
You: もっと詳しく
Alexa: （詳細な説明を提供）

You: 他には？
Alexa: （他の情報を提供）

You: なるほど
Alexa: （会話を継続）
```

## 📋 追加された主な会話パターン

### 選択・指示系
- 番号選択: 「1番」「2番」「最初の」「次の」
- 指示語: 「それ」「それで」「それをお願い」
- 選択確定: 「〜でお願い」「〜にします」「〜がいい」

### 質問継続系
- 詳細要求: 「もっと詳しく」「詳細を」「具体的に」
- 理由質問: 「なぜ」「どうして」「理由は」
- 例示要求: 「例えば」「具体例を」

### 会話制御系
- 継続: 「続けて」「次」「あと」
- 繰り返し: 「もう一度」「もう一回」
- 切り替え: 「他には」「別の」「違うこと」

### 相槌・応答系
- 理解: 「なるほど」「わかりました」「了解」
- 確認: 「本当に」「本当ですか」
- 感想: 「すごい」「面白い」「いいね」

## ⚠️ 注意事項

1. **インタラクションモデルは「ビルド」タブから更新**
   - コードタブではなくビルドタブを使用
   - JSONエディターで更新

2. **モデルのビルド完了を待つ**
   - ビルドには1-2分かかる
   - 完了通知を確認してからテスト

3. **会話履歴のサイズ制限**
   - 100件まで保持
   - それ以上は古いものから削除

## 🔧 トラブルシューティング

### 問題: 会話が継続しない
- インタラクションモデルのビルドが完了しているか確認
- Lambda関数が最新版にデプロイされているか確認
- セッションタイムアウト（約8-10分）していないか確認

### 問題: FallbackIntentになる
- 発話がインタラクションモデルに含まれているか確認
- モデルのビルドが成功しているか確認

### 問題: 文脈を理解しない
- Lambda関数の会話履歴機能が有効か確認
- conversation_historyが正しく保存されているか確認

## 📊 パフォーマンス最適化

- クエリ: 最大200文字
- 応答: 最大1000文字（物語対応）
- 会話履歴: 最大100件
- GPT-5への送信: 最新10件

## 🚦 次のステップ（オプション）

### DynamoDB永続化
セッションを超えて会話を保持したい場合：
1. DynamoDBテーブル作成
2. Lambda関数にDynamoDB権限付与
3. dynamodb_persistence.pyを統合

---

更新日: 2024-01-XX
バージョン: 2.0（会話継続機能対応）