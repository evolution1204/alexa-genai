# CloudWatchアクセス権限問題の解決方法

## 問題
Alexa開発者コンソールからCloudWatchログにアクセスできない：
```
User: arn:aws:sts::634183828881:assumed-role/VoiceHubSSORole/VoiceHubSSORole
is not authorized to perform: cloudwatch:GetMetricData
```

## 解決方法

### 方法1: デバッグモードでのテスト（推奨）

Lambda関数を更新して、エラー詳細を直接Alexaの応答で確認できるようにしました。

1. **Alexaコンソールでコードを再デプロイ**
   - コードタブ → デプロイ

2. **テストタブでデバッグ情報を確認**
   ```
   ユーザー: じぇないを開いて
   Alexa: [APIキーの状態が表示されます]

   ユーザー: こんにちは
   Alexa: [テスト応答またはエラー詳細が表示されます]
   ```

### 方法2: AWSアカウント所有者に依頼

CloudWatchログを見るには、AWSアカウントの所有者に以下を依頼：

1. **AWS IAMで権限を追加**
   - `CloudWatchLogsReadOnlyAccess` ポリシーを付与
   - または `CloudWatchFullAccess` ポリシーを付与

2. **直接AWSコンソールにログイン**
   - AWSアカウントの認証情報を取得
   - https://console.aws.amazon.com/ にログイン
   - CloudWatch → ログ → ロググループ

### 方法3: Lambda関数の自己診断機能

現在のLambda関数には以下の自己診断機能があります：

#### APIキー状態の確認
- 起動時：APIキーが設定されているか通知
- エラー時：具体的なエラー内容を応答

#### テストモード
APIキーなしでも基本動作を確認：
- 「こんにちは」→ テスト応答
- 「生成AIとは」→ 簡易説明
- その他 → デフォルト応答

## 確認手順

### 1. APIキーが設定されているか確認

Alexaコンソールのコードエディタで：
```python
# 23行目
OPENAI_API_KEY_DIRECT = "sk-proj-xxxxx"  # ← ここに値があるか確認
```

### 2. デプロイ状態の確認

1. コードを保存
2. デプロイボタンをクリック
3. "Deploy successful" を確認

### 3. テストでの確認

Alexaテストシミュレーターで：
```
じぇないを開いて
→ APIキーの状態が応答に含まれる

こんにちは
→ 正常応答またはエラー詳細
```

## トラブルシューティング

### よくある原因

1. **APIキー未設定**
   - 23行目が空文字列のまま
   - 解決：APIキーを設定

2. **APIキー形式エラー**
   - クォート忘れ
   - スペース混入
   - 解決：`"sk-proj-xxxxx"`形式で設定

3. **デプロイ忘れ**
   - コード変更後にデプロイしていない
   - 解決：デプロイボタンをクリック

4. **リージョン不一致**
   - Lambdaリージョンが異なる
   - 解決：通常は自動設定されるため問題なし

## 代替ログ確認方法

### Alexaコンソールの開発者ツール

1. **テストタブ** → **デバイスログ**
   - 基本的なリクエスト/レスポンス確認

2. **テストタブ** → **JSONエディター**
   - リクエスト/レスポンスの詳細確認

3. **監視タブ** → **メトリクス**
   - 成功率、レイテンシーなど

## 推奨アクション

1. まずは更新したコードをデプロイ
2. テストシミュレーターで動作確認
3. APIキー設定状態を確認
4. 必要に応じてAWS管理者に権限付与を依頼

---

作成日: 2025-09-22
問題: CloudWatchアクセス権限エラー
状態: 回避策実装済み